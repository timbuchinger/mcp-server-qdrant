name: Publish Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump: major, minor, or patch'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: 'Create as prerelease (true/false)'
        required: false
        default: 'false'

permissions:
  contents: write
  checks: write
  issues: write
  # 'metadata' permission removed: not accepted by all GitHub Actions schemas

jobs:
  publish:
    name: Compute version, tag and create release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next version
        id: semver
        run: |
          set -euo pipefail
          bump="${{ github.event.inputs.version_type }}"
          prerelease="${{ github.event.inputs.prerelease }}"

          latest_tag=$(git tag --list 'v*' --sort=-v:refname | head -n1 || true)
          if [ -z "$latest_tag" ]; then
            latest_version="0.0.0"
          else
            latest_version=${latest_tag#v}
          fi

          IFS=. read -r major minor patch <<< "$latest_version"
          major=${major:-0}; minor=${minor:-0}; patch=${patch:-0}

          case "$bump" in
            major) major=$((major+1)); minor=0; patch=0;;
            minor) minor=$((minor+1)); patch=0;;
            patch) patch=$((patch+1));;
            *) echo "Unknown bump: $bump"; exit 1;;
          esac

          next_version="$major.$minor.$patch"

          if [ "$prerelease" = "true" ]; then
            rc_list=$(git tag --list "v${next_version}-rc*" --sort=-v:refname)
            if [ -z "$rc_list" ]; then
              rc=1
            else
              last=$(echo "$rc_list" | head -n1)
              last_num=$(echo "$last" | sed -E 's/^v'"$next_version"'-rc\.?([0-9]+)$/\1/')
              if [ -z "$last_num" ]; then
                rc=1
              else
                rc=$((last_num+1))
              fi
            fi
            tag="v${next_version}-rc${rc}"
          else
            tag="v${next_version}"
          fi

          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "next_version=$next_version" >> $GITHUB_OUTPUT
          echo "tag=$tag" >> $GITHUB_OUTPUT

      - name: Create and push tag
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          tag=${{ steps.semver.outputs.tag }}
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$tag" -m "Release $tag"
          origin_url="https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          git remote set-url origin "$origin_url"
          git push origin "$tag"

      - name: Set up Python for build
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install build tools
        run: python -m pip install --upgrade build

      - name: Build distribution
        run: python -m build

      - name: Create GitHub release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.semver.outputs.tag }}
          release_name: ${{ steps.semver.outputs.tag }}
          body: "Release ${{ steps.semver.outputs.tag }} (generated by workflow)"
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload distribution files to GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.semver.outputs.tag }}
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
